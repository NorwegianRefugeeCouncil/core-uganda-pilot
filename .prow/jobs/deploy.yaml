postsubmits:
  - name: core_deploy
    branches:
      - main
    decorate: true
    labels:
      aadpodidbinding: prow
      preset-build-tasks: "true"
      preset-backbone: "true"
    spec:
      containers:
        - image: digitalbackbonecr.azurecr.io/docker-builder:latest
          name: az-acr-login
          command: [ "task", "--name=az_acr_login", "az_acr_login --container-registry=digitalbackbonecr.azurecr.io" ]
        - image: digitalbackbonecr.azurecr.io/docker-builder:latest
          name: clone-backbone
          command: [ "task", "--name=clone_backbone", "clone_backbone" ]
          volumeMounts:
            - name: backbone-ssh-key
              mountPath: /secrets/ssh/backbone-ssh-key
              readOnly: true
        - image: digitalbackbonecr.azurecr.io/docker-builder:latest
          name: tag
          command: [ "task", "--name=tag", 'cd /home/prow/go/src/github.com/nrc-no/core && echo -n "$(get_image_tag)" > /tmp/shared/tag' ]
        - image: digitalbackbonecr.azurecr.io/docker-builder:latest
          name: build
          command:
            - 'task'
            - '--name=build'
            - 'waitfor az_acr_login tag && cd /workspace && /kaniko/executor --context="dir:///home/prow/go/src/github.com/nrc-no/core/api" --dockerfile="Dockerfile" --destination="digitalbackbonecr.azurecr.io/nrc-no/core:$(cat /tmp/shared/tag)"'
